import org.openapitools.generator.gradle.plugin.tasks.GenerateTask

buildscript{
   repositories{
      mavenLocal()
      maven{url "https://repo1.maven.org/maven2"}
   }
}

plugins{
   id 'org.openapi.generator' version '6.2.1'
   id 'maven-publish'
   id 'java-gradle-plugin'
   id 'net.nemerosa.versioning' version '2.8.2'
}

openApiGenerate{
   generatorName = 'jaxrs-spec'
   inputSpec = "$rootDir/src/main/resources/openapi.yaml"
   configFile = "$rootDir/src/main/resources/config.yaml"
   outputDir = "$buildDir/generated/java"
   configOptions = [
      useJakartaEe : "true"
   ]
}

tasks.register('copyGenerated', Copy) {
   from "${rootDir}/build/generated/java/src/gen/java"
   into "${rootDir}/src/main/java"
}


openApiValidate{
   inputSpec = "${rootDir}/src/main/resources/openapi.yaml"
}

sourceSets{
   main{
      java{
         srcDir "$buildDir/generated/src/main/java"
      }
   }
}

dependencies{
   compileOnly 'jakarta.platform:jakarta.jakartaee-api:9.1.0'
   implementation group: 'com.squareup.okhttp3', name: 'okhttp', version: '4.10.0'
   implementation group: 'io.swagger.codegen.v3', name: 'swagger-generator', version: '3.0.36'
   implementation group: 'io.swagger.core.v3', name: 'swagger-annotations-jakarta', version: '2.2.8'
   implementation group: 'io.swagger.core.v3', name: 'swagger-jaxrs2', version: '2.2.8'
}

publishing{
   publications{
      maven(MavenPublication){
         groupId findProperty('group')
         artifactId findProperty('name')
         version findProperty('version') + '-' + findProperty('classifier')

         from components.java
      }
   }
}

clean {
   delete 'src/main/java'
}

tasks.copyGenerated.dependsOn('openApiGenerate')
tasks.openApiGenerate.dependsOn('openApiValidate')
compileJava.dependsOn('copyGenerated')
publishToMavenLocal.dependsOn(build)
